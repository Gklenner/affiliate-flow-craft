/**
 * Sistema de Email Marketing Avan√ßado com IA
 * Segmenta√ß√£o por nicho + EmailJS + Automa√ß√£o
 */

import emailjs from '@emailjs/browser';

// Tipos para segmenta√ß√£o
export type NichoAudiencia = 'tech' | 'financas' | 'business' | 'ia' | 'marketing' | 'geral';

export interface LeadData {
  email: string;
  nome?: string;
  nicho: NichoAudiencia;
  fonte: string;
  utm_source?: string;
  utm_medium?: string;
  utm_campaign?: string;
  step_atual: number;
  timestamp: string;
}

export interface EmailTemplate {
  subject: string;
  html: string;
  text: string;
  delay_hours: number;
}

export interface SequenciaEmail {
  nicho: NichoAudiencia;
  templates: EmailTemplate[];
}

class EmailMarketingManager {
  private static instance: EmailMarketingManager;
  private serviceId = 'service_affiliateflow';
  private templateId = 'template_nurturing';
  private publicKey = 'YOUR_EMAILJS_PUBLIC_KEY';

  public static getInstance(): EmailMarketingManager {
    if (!EmailMarketingManager.instance) {
      EmailMarketingManager.instance = new EmailMarketingManager();
    }
    return EmailMarketingManager.instance;
  }

  // Inicializa√ß√£o do EmailJS
  public initialize() {
    emailjs.init(this.publicKey);
    console.log('‚úÖ EmailJS inicializado');
  }

  // Detec√ß√£o autom√°tica de nicho baseada em email e UTM
  public detectarNicho(email: string, utmParams: Record<string, string> = {}): NichoAudiencia {
    const emailDomain = email.split('@')[1]?.toLowerCase() || '';
    const { utm_source, utm_medium, utm_campaign } = utmParams;

    // Detec√ß√£o por dom√≠nio de email
    const techDomains = ['gmail.com', 'hotmail.com', 'outlook.com', 'yahoo.com'];
    const businessDomains = ['empresa.com', 'corp.com', 'ltda.com', 'sa.com'];
    
    // Detec√ß√£o por UTM
    if (utm_campaign?.includes('tech') || utm_source?.includes('tech')) return 'tech';
    if (utm_campaign?.includes('financas') || utm_source?.includes('financas')) return 'financas';
    if (utm_campaign?.includes('business') || utm_source?.includes('business')) return 'business';
    if (utm_campaign?.includes('ia') || utm_source?.includes('ia')) return 'ia';
    if (utm_campaign?.includes('marketing') || utm_source?.includes('marketing')) return 'marketing';

    // Detec√ß√£o por dom√≠nio
    if (businessDomains.some(domain => emailDomain.includes(domain))) return 'business';
    if (techDomains.includes(emailDomain)) return 'tech';

    return 'geral';
  }

  // Sequ√™ncias de nurturing por nicho
  private getSequenciaNurturing(nicho: NichoAudiencia): SequenciaEmail {
    const sequencias: Record<NichoAudiencia, SequenciaEmail> = {
      tech: {
        nicho: 'tech',
        templates: [
          {
            subject: 'ü§ñ Bem-vindo ao futuro da IA empresarial!',
            html: this.getTemplateHTML('tech', 1),
            text: 'Bem-vindo! Voc√™ est√° prestes a descobrir como a IA pode revolucionar neg√≥cios.',
            delay_hours: 0
          },
          {
            subject: '‚ö° Como a IA est√° gerando R$ 55k/m√™s para indicadores',
            html: this.getTemplateHTML('tech', 2),
            text: 'Cases reais de como indicadores tech est√£o faturando alto com IA.',
            delay_hours: 24
          },
          {
            subject: 'üöÄ Scripts t√©cnicos que convertem empresas em 48h',
            html: this.getTemplateHTML('tech', 3),
            text: 'Scripts prontos para apresentar IA para CTOs e diretores de TI.',
            delay_hours: 72
          }
        ]
      },
      financas: {
        nicho: 'financas',
        templates: [
          {
            subject: 'üí∞ ROI de 300% indicando IA para empresas',
            html: this.getTemplateHTML('financas', 1),
            text: 'Descubra o modelo de neg√≥cio mais rent√°vel de 2024.',
            delay_hours: 0
          },
          {
            subject: 'üìä Planilha: Calcule sua renda recorrente com IA',
            html: this.getTemplateHTML('financas', 2),
            text: 'Ferramenta exclusiva para projetar seus ganhos mensais.',
            delay_hours: 24
          },
          {
            subject: 'üéØ Como diversificar renda com IA empresarial',
            html: this.getTemplateHTML('financas', 3),
            text: 'Estrat√©gias de investimento em conhecimento que pagam para sempre.',
            delay_hours: 72
          }
        ]
      },
      business: {
        nicho: 'business',
        templates: [
          {
            subject: 'üè¢ Empresas pagam R$ 5k+/m√™s por solu√ß√µes de IA',
            html: this.getTemplateHTML('business', 1),
            text: 'O mercado B2B de IA est√° explodindo. Posicione-se agora.',
            delay_hours: 0
          },
          {
            subject: 'üìà Cases: Como indicadores B2B faturam 6 d√≠gitos',
            html: this.getTemplateHTML('business', 2),
            text: 'Hist√≥rias reais de empreendedores que dominaram o mercado de IA.',
            delay_hours: 24
          },
          {
            subject: 'ü§ù Network exclusivo de indicadores premium',
            html: this.getTemplateHTML('business', 3),
            text: 'Acesso ao grupo VIP de indicadores que faturam alto.',
            delay_hours: 72
          }
        ]
      },
      ia: {
        nicho: 'ia',
        templates: [
          {
            subject: 'üß† IA Empresarial: O mercado de R$ 50 bilh√µes',
            html: this.getTemplateHTML('ia', 1),
            text: 'Como especialistas em IA est√£o monetizando conhecimento.',
            delay_hours: 0
          },
          {
            subject: '‚öôÔ∏è Demonstra√ß√µes de IA que fecham contratos',
            html: this.getTemplateHTML('ia', 2),
            text: 'Templates t√©cnicos para mostrar o poder da IA para empresas.',
            delay_hours: 24
          },
          {
            subject: 'üî¨ Tend√™ncias IA 2024: Onde investir tempo',
            html: this.getTemplateHTML('ia', 3),
            text: 'Insights exclusivos sobre o futuro da IA empresarial.',
            delay_hours: 72
          }
        ]
      },
      marketing: {
        nicho: 'marketing',
        templates: [
          {
            subject: 'üì± IA para Marketing: Automa√ß√£o que vende 24/7',
            html: this.getTemplateHTML('marketing', 1),
            text: 'Como marketers est√£o usando IA para escalar resultados.',
            delay_hours: 0
          },
          {
            subject: 'üéØ Funis de IA que convertem 40% mais',
            html: this.getTemplateHTML('marketing', 2),
            text: 'Estrat√©gias de automa√ß√£o que seus concorrentes n√£o conhecem.',
            delay_hours: 24
          },
          {
            subject: 'üìä Dashboard: M√©tricas de IA que importam',
            html: this.getTemplateHTML('marketing', 3),
            text: 'KPIs exclusivos para medir sucesso em projetos de IA.',
            delay_hours: 72
          }
        ]
      },
      geral: {
        nicho: 'geral',
        templates: [
          {
            subject: 'üöÄ Renda Recorrente com IA: Guia Completo',
            html: this.getTemplateHTML('geral', 1),
            text: 'Descubra como gerar renda indicando IA para empresas.',
            delay_hours: 0
          },
          {
            subject: 'üí° 5 Nichos que mais contratam IA em 2024',
            html: this.getTemplateHTML('geral', 2),
            text: 'Oportunidades de ouro no mercado de IA empresarial.',
            delay_hours: 24
          },
          {
            subject: 'üéÅ Kit Completo: Materiais para Indicadores',
            html: this.getTemplateHTML('geral', 3),
            text: 'Tudo que voc√™ precisa para come√ßar a indicar IA hoje.',
            delay_hours: 72
          }
        ]
      }
    };

    return sequencias[nicho];
  }

  // Templates HTML personalizados por nicho
  private getTemplateHTML(nicho: NichoAudiencia, emailNumber: number): string {
    const baseTemplate = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AffiliateFlow Pro</title>
        <style>
          body { font-family: 'Inter', Arial, sans-serif; line-height: 1.6; color: #333; }
          .container { max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #0052FF 0%, #8B5CF6 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
          .content { background: white; padding: 30px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
          .cta-button { display: inline-block; background: linear-gradient(135deg, #FF6F00 0%, #FF8A00 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 20px 0; }
          .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>ü§ñ AffiliateFlow Pro</h1>
            <p>Renda Recorrente Indicando IA para Empresas</p>
          </div>
          <div class="content">
            ${this.getContentByNicho(nicho, emailNumber)}
          </div>
          <div class="footer">
            <p>¬© 2024 AffiliateFlow Pro - Todos os direitos reservados</p>
            <p>Voc√™ est√° recebendo este email porque se cadastrou em nosso sistema.</p>
          </div>
        </div>
      </body>
      </html>
    `;

    return baseTemplate;
  }

  // Conte√∫do espec√≠fico por nicho e email
  private getContentByNicho(nicho: NichoAudiencia, emailNumber: number): string {
    const conteudos: Record<NichoAudiencia, Record<number, string>> = {
      tech: {
        1: `
          <h2>üöÄ Bem-vindo ao futuro da IA empresarial!</h2>
          <p>Como desenvolvedor/tech, voc√™ est√° na posi√ß√£o perfeita para capitalizar a revolu√ß√£o da IA empresarial.</p>
          <p><strong>Por que agora √© o momento ideal:</strong></p>
          <ul>
            <li>üî• Demanda por IA empresarial cresceu 340% em 2024</li>
            <li>üí∞ Empresas pagam R$ 5k+ mensais por solu√ß√µes de IA</li>
            <li>üéØ Indicadores tech faturam R$ 55k/m√™s (Enterprise)</li>
          </ul>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">ü§ñ Acessar Sistema GRIP</a>
          <p><strong>Pr√≥ximo email:</strong> Cases reais de indicadores tech faturando 6 d√≠gitos.</p>
        `,
        2: `
          <h2>‚ö° Como a IA est√° gerando R$ 55k/m√™s para indicadores</h2>
          <p><strong>Case Real - Jo√£o, Desenvolvedor Full Stack:</strong></p>
          <blockquote>"Em 3 meses indicando IA para startups, j√° faturei R$ 165k. O segredo √© mostrar ROI t√©cnico real."</blockquote>
          <p><strong>Estrat√©gia que funciona:</strong></p>
          <ol>
            <li>Identifica empresas com processos manuais</li>
            <li>Demonstra automa√ß√£o com IA em 15 minutos</li>
            <li>Apresenta ROI de 300% em 6 meses</li>
            <li>Fecha contratos de R$ 5k+ mensais</li>
          </ol>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">üìä Ver Demonstra√ß√£o T√©cnica</a>
        `,
        3: `
          <h2>üöÄ Scripts t√©cnicos que convertem empresas em 48h</h2>
          <p><strong>Script para CTOs (Taxa de convers√£o: 67%):</strong></p>
          <blockquote>"Ol√° [Nome], vi que voc√™s usam [tecnologia]. Implementamos IA que reduz 80% do tempo em [processo espec√≠fico]. Posso mostrar em 15 min como isso geraria R$ [valor] mensais para voc√™s?"</blockquote>
          <p><strong>Demonstra√ß√£o t√©cnica que fecha:</strong></p>
          <ul>
            <li>üîß Integra√ß√£o via API em tempo real</li>
            <li>üìà Dashboard com m√©tricas de performance</li>
            <li>‚ö° Automa√ß√£o de processos cr√≠ticos</li>
            <li>üõ°Ô∏è Seguran√ßa enterprise-grade</li>
          </ul>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">üõ†Ô∏è Baixar Scripts Completos</a>
        `
      },
      financas: {
        1: `
          <h2>üí∞ ROI de 300% indicando IA para empresas</h2>
          <p>Como investidor/analista financeiro, voc√™ entende de n√∫meros. Veja os n√∫meros da IA empresarial:</p>
          <p><strong>Modelo de Neg√≥cio Recorrente:</strong></p>
          <ul>
            <li>üìä Investimento inicial: R$ 0 (apenas tempo)</li>
            <li>üíµ Retorno mensal: R$ 15k a R$ 55k por empresa</li>
            <li>üìà Crescimento: 40% ao m√™s (m√©dia do setor)</li>
            <li>üéØ Margem: 95% (renda quase 100% l√≠quida)</li>
          </ul>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">üìà Calcular Meu ROI</a>
          <p><strong>Pr√≥ximo email:</strong> Planilha exclusiva para projetar ganhos.</p>
        `,
        2: `
          <h2>üìä Planilha: Calcule sua renda recorrente com IA</h2>
          <p><strong>Simula√ß√£o Real - Indicador Financeiro:</strong></p>
          <table border="1" style="width:100%; border-collapse: collapse;">
            <tr><th>M√™s</th><th>Empresas</th><th>Faturamento</th><th>Acumulado</th></tr>
            <tr><td>1</td><td>2</td><td>R$ 30.000</td><td>R$ 30.000</td></tr>
            <tr><td>2</td><td>4</td><td>R$ 60.000</td><td>R$ 90.000</td></tr>
            <tr><td>3</td><td>6</td><td>R$ 90.000</td><td>R$ 180.000</td></tr>
            <tr><td>6</td><td>12</td><td>R$ 180.000</td><td>R$ 720.000</td></tr>
          </table>
          <p><strong>F√≥rmula do sucesso:</strong> Cada empresa = R$ 15k/m√™s recorrente</p>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">üìã Baixar Planilha Completa</a>
        `,
        3: `
          <h2>üéØ Como diversificar renda com IA empresarial</h2>
          <p><strong>Portfolio de Renda Recorrente:</strong></p>
          <ul>
            <li>üè¶ Fintechs: R$ 25k/m√™s (automa√ß√£o financeira)</li>
            <li>üè• Cl√≠nicas: R$ 15k/m√™s (agendamento IA)</li>
            <li>üõí E-commerce: R$ 35k/m√™s (chatbots de vendas)</li>
            <li>üè¢ Consultorias: R$ 45k/m√™s (IA para processos)</li>
          </ul>
          <p><strong>Total mensal:</strong> R$ 120k em renda recorrente</p>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">üíº Montar Meu Portfolio</a>
        `
      },
      // Adicionar outros nichos...
      geral: {
        1: `
          <h2>üöÄ Renda Recorrente com IA: Guia Completo</h2>
          <p>Voc√™ est√° prestes a descobrir o modelo de neg√≥cio mais rent√°vel de 2024:</p>
          <p><strong>Como funciona:</strong></p>
          <ol>
            <li>üéØ Identifica empresas que precisam de IA</li>
            <li>ü§ñ Apresenta solu√ß√µes GRIP personalizadas</li>
            <li>üí∞ Recebe comiss√µes recorrentes mensais</li>
            <li>üìà Escala sem limite de indica√ß√µes</li>
          </ol>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">üöÄ Come√ßar Agora</a>
        `,
        2: `
          <h2>üí° 5 Nichos que mais contratam IA em 2024</h2>
          <p><strong>Oportunidades de ouro:</strong></p>
          <ul>
            <li>üõí <strong>E-commerce:</strong> Chatbots que vendem 24/7</li>
            <li>üè• <strong>Sa√∫de:</strong> Agendamento e triagem autom√°tica</li>
            <li>üè¶ <strong>Finan√ßas:</strong> An√°lise de cr√©dito com IA</li>
            <li>üìö <strong>Educa√ß√£o:</strong> Tutores virtuais inteligentes</li>
            <li>üè¢ <strong>Servi√ßos:</strong> Automa√ß√£o de processos</li>
          </ul>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">üéØ Escolher Meu Nicho</a>
        `,
        3: `
          <h2>üéÅ Kit Completo: Materiais para Indicadores</h2>
          <p><strong>Seu arsenal completo:</strong></p>
          <ul>
            <li>üìã Scripts de abordagem por nicho</li>
            <li>üé¨ V√≠deos de demonstra√ß√£o</li>
            <li>üìä Cases de sucesso reais</li>
            <li>üíº Templates de propostas</li>
            <li>üì± App GRIP completo</li>
          </ul>
          <a href="https://grip.gaiodataos.com/?si=f722bc5f-c550-4368-a50f-d727e7abc368" class="cta-button">üì¶ Baixar Kit Completo</a>
        `
      }
    };

    return conteudos[nicho]?.[emailNumber] || conteudos.geral[emailNumber];
  }

  // Captura e processamento de leads
  public async capturarLead(leadData: LeadData): Promise<boolean> {
    try {
      // Detecta nicho automaticamente se n√£o fornecido
      if (leadData.nicho === 'geral') {
        leadData.nicho = this.detectarNicho(leadData.email, {
          utm_source: leadData.utm_source,
          utm_medium: leadData.utm_medium,
          utm_campaign: leadData.utm_campaign
        });
      }

      // Salva no Airtable (implementar integra√ß√£o)
      await this.salvarNoAirtable(leadData);

      // Inicia sequ√™ncia de nurturing
      await this.iniciarSequenciaNurturing(leadData);

      console.log('‚úÖ Lead capturado e sequ√™ncia iniciada:', leadData);
      return true;
    } catch (error) {
      console.error('‚ùå Erro ao capturar lead:', error);
      return false;
    }
  }

  // Envio de email via EmailJS
  private async enviarEmail(
    destinatario: string,
    template: EmailTemplate,
    nicho: NichoAudiencia
  ): Promise<boolean> {
    try {
      const templateParams = {
        to_email: destinatario,
        subject: template.subject,
        html_content: template.html,
        text_content: template.text,
        nicho: nicho
      };

      await emailjs.send(this.serviceId, this.templateId, templateParams);
      console.log('üìß Email enviado:', template.subject);
      return true;
    } catch (error) {
      console.error('‚ùå Erro ao enviar email:', error);
      return false;
    }
  }

  // Inicia sequ√™ncia de nurturing
  private async iniciarSequenciaNurturing(leadData: LeadData): Promise<void> {
    const sequencia = this.getSequenciaNurturing(leadData.nicho);
    
    for (const template of sequencia.templates) {
      // Agenda envio com delay
      setTimeout(async () => {
        await this.enviarEmail(leadData.email, template, leadData.nicho);
      }, template.delay_hours * 60 * 60 * 1000);
    }
  }

  // Integra√ß√£o com Airtable (placeholder)
  private async salvarNoAirtable(leadData: LeadData): Promise<void> {
    // Implementar integra√ß√£o com Airtable API
    console.log('üíæ Salvando no Airtable:', leadData);
  }

  // Lead magnets personalizados por nicho
  public getLeadMagnet(nicho: NichoAudiencia): { titulo: string; descricao: string; url: string } {
    const leadMagnets: Record<NichoAudiencia, any> = {
      tech: {
        titulo: 'ü§ñ Guia T√©cnico: IA Empresarial para Devs',
        descricao: 'APIs, integra√ß√µes e arquitetura de IA que empresas pagam R$ 50k+',
        url: '/downloads/guia-tecnico-ia-empresarial.pdf'
      },
      financas: {
        titulo: 'üìä Planilha: ROI de IA Empresarial',
        descricao: 'Calcule exatamente quanto voc√™ pode ganhar indicando IA',
        url: '/downloads/planilha-roi-ia-empresarial.xlsx'
      },
      business: {
        titulo: 'üè¢ Cases B2B: IA que Transforma Neg√≥cios',
        descricao: '50 cases reais de empresas que 10x resultados com IA',
        url: '/downloads/cases-b2b-ia-transformacao.pdf'
      },
      ia: {
        titulo: 'üß† Roadmap IA 2024: Tend√™ncias e Oportunidades',
        descricao: 'Onde investir tempo e energia no mercado de IA',
        url: '/downloads/roadmap-ia-2024-oportunidades.pdf'
      },
      marketing: {
        titulo: 'üì± Automa√ß√µes de IA que Vendem 24/7',
        descricao: 'Funis inteligentes que convertem enquanto voc√™ dorme',
        url: '/downloads/automacoes-ia-vendas-247.pdf'
      },
      geral: {
        titulo: 'üöÄ Domine a Nova Economia Digital',
        descricao: 'Guia completo para gerar renda recorrente com IA',
        url: '/downloads/domine-nova-economia-digital.pdf'
      }
    };

    return leadMagnets[nicho];
  }
}

export default EmailMarketingManager;